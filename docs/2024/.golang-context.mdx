



context

WithTimeout() 和 WithDeadline() 有啥区别？

timeout用来控制goroutine的执行时间，ddl用来控制goroutine的最长执行时间。

```markdown
通常健壮的程序都是要设置超时时间的，避免因为服务端长时间响应消耗资源，所以一些web框架或rpc框架都会采用withTimeout或者withDeadline来做超时控制，当一次请求到达我们设置的超时时间，就会及时取消，不在往下执行。withTimeout和withDeadline作用是一样的，就是传递的时间参数不同而已，他们都会通过传入的时间来自动取消Context，这里要注意的是他们都会返回一个cancelFunc方法，通过调用这个方法可以达到提前进行取消，不过在使用的过程还是建议在自动取消后也调用cancelFunc去停止定时减少不必要的资源浪费。

withTimeout、WithDeadline不同在于WithTimeout将持续时间作为参数输入而不是时间对象，这两个方法使用哪个都是一样的，看业务场景和个人习惯了，因为本质withTimout内部也是调用的WithDeadline。
```

WithTimeout内部就是调用的WithDeadline方法


[Context源码，再度重相逢](https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&mid=2651450798&idx=3&sn=6f59d1c66137ee7b785644dfd7fb0679)

```markdown
源码分析

 ctx存储键值对

 ctx的取消机制

---

源码赏析

 if >= 2 用switch替换

 atomic.Value 替换chan struct 减少锁使用

 加锁前，先获取值避免加锁

 String逻辑赏析

 一个Bug
```


```markdown
emptyCtx主要是给我们创建根Context时使用的，其实现方法也是一个空结构

valueCtx目的就是为Context携带键值对，因为它采用匿名接口的继承实现方式，他会继承父Context，也就相当于嵌入Context当中了
```

emptyCtx

valueCtx


```markdown
cancel方法
最后我们再来看一下返回的cancel方法是如何实现，这个方法会关闭上下文中的 Channel 并向所有的子上下文同步取消信号：
```

